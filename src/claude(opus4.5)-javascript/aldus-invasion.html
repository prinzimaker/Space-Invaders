<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ALDUS INVASION - JavaScript Edition</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: 'Press Start 2P', monospace;
            overflow: hidden;
        }
        
        .scanlines {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            background: repeating-linear-gradient(0deg, rgba(0,0,0,0.15), rgba(0,0,0,0.15) 1px, transparent 1px, transparent 2px);
            z-index: 100;
        }
        
        .crt-effect {
            position: relative;
            border: 8px solid #222;
            border-radius: 20px;
            box-shadow: 0 0 50px rgba(0,255,0,0.3), inset 0 0 50px rgba(0,0,0,0.5);
            background: #111;
            padding: 10px;
        }
        
        #gameCanvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            background: #000;
        }
        
        .title {
            color: #0f0;
            text-shadow: 0 0 10px #0f0, 0 0 20px #0f0;
            margin-bottom: 20px;
            font-size: 14px;
            text-align: center;
            animation: glow 2s ease-in-out infinite;
        }
        
        @keyframes glow {
            0%, 100% { text-shadow: 0 0 10px #0f0, 0 0 20px #0f0; }
            50% { text-shadow: 0 0 20px #0f0, 0 0 40px #0f0, 0 0 60px #0f0; }
        }
        
        .controls { color: #0ff; font-size: 8px; margin-top: 15px; text-align: center; line-height: 1.8; }
        .author { color: #ff0; font-size: 6px; margin-top: 10px; text-align: center; }
    </style>
</head>
<body>
    <div class="scanlines"></div>
    <div class="title">ALDUS INVASION</div>
    <div class="crt-effect">
        <canvas id="gameCanvas" width="640" height="400"></canvas>
    </div>
    <div class="controls">← → MUOVI | SPAZIO SPARA | P PAUSA | S SUONO | ENTER INIZIA</div>
    <div class="author">FREEWARE GAME WRITTEN by ALDO PRINZI - 1994 | JS CONVERSION 2024</div>

    <script>
    // ============================================================================
    // ALDUS INVASION - JavaScript Edition
    // Conversione del gioco originale QBasic di Aldo Prinzi (1994)
    // ============================================================================

    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    const SCALE = 2;
    const WIDTH = 320;
    const HEIGHT = 200;
    
    // Timing (millisecondi) - calibrati sull'originale BASIC
    const TIMING = {
        ALIEN_BASE_MOVE: 400,
        UFO_MOVE: 100,           // UFO velocità raddoppiata
        PLAYER_BULLET: 20,
        ALIEN_BULLET: 35,
        PLAYER_MOVE: 20,
        ALIEN_SHOOT_CHECK: 600,
        UFO_SPAWN_CHECK: 1200,
        JOKE_FRAME: 100,
    };
    
    // Palette VGA
    const VGA_PALETTE = {
        '0': '#000000', '1': '#0000AA', '2': '#00AA00', '3': '#00AAAA',
        '4': '#AA0000', '5': '#AA00AA', '6': '#AA5500', '7': '#AAAAAA',
        '8': '#555555', '9': '#5555FF', 'A': '#55FF55', 'B': '#55FFFF',
        'C': '#FF5555', 'D': '#FF55FF', 'E': '#FFFF55', 'F': '#FFFFFF',
    };

    // ============================================================================
    // SPRITE DATA
    // ============================================================================
    
    const SPRITE_DATA = {
        razzo: [
            "        4          ","        4          ","        4          ",
            "       414         ","       414         ","      41314        ",
            "     4137314       ","    413337314      ","    413337314      ",
            "    411333114      ","    411111114      ","    441111144      ",
            "    244424442      ","    211121112      ","   22111211122     ",
            "   22111211122     ","   22111211122     ","  2225552555222    ",
            "  2222  2  2222    ","  222   2   222    "," 222    2    222   ",
            " 22     2     22   "," 2      2      2   "
        ],
        
        mostro0_1: ["  55  22222  55  ","    522222225    ","  2222228222222  ","  2227072227072  ","  2222228222222  ","  2232328232322  ","    333363333    ","     3336 333    ","   333  6  333   "," 333      333    "],
        mostro0_2: [" 5   222 222   5 ","  5552222222555  ","  2222228222222  ","  2707222707222  ","  2222228222222  ","   23238383232   ","    333343333    ","    333 4333     ","   333     333   ","    333      333 "],
        mostro1_1: ["        666      ","      6633366    ","  55663E333E36655","  55663E333E36655","     663333366   ","     663333366   ","      3631363    ","    66  66  66   ","   66  66  66    ","  66  66  66     "],
        mostro1_2: ["      666        ","    6633366      ","55663E333E36655  ","55663E333E36655  ","   663333366     ","   663333366     ","    3631363      ","   66  66  66    ","    66  66  66   ","     66  66  66  "],
        mostro2_1: ["  66         66  ","    6 35553 6    ","    355555553    ","  3577555577553  "," 355555555555553 "," 355555333555553 ","  3555555555553  ","    5   5   5    ","   5    5    5   ","    55     55    "],
        mostro2_2: ["        6        ","   66 35553 66   ","  6 355555553 6  ","  3557755557753  "," 355555535555553 "," 355555333555553 ","  3555553555553  ","   55   5   55   ","  5     5     5  "," 55    5 5    55 "],
        mostro3_1: ["       555 555   "," 77   57775      ","  7 177777771    ","  777E477E47777  ","    177777771 7  ","    177444771 77 ","      77777      ","     77   77     ","    77     77    "," 7777     7777   "],
        mostro3_2: ["   555 555       ","      57775   77 ","    377777773 7  ","  77774E774E777  ","  7 377777773    "," 77 377747773    ","      77777      ","     77   77     ","    77     77    ","   7777     7777 "],
        mostro4_1: [" 64           46 ","   44411111444   ","    111111111    ","   17331733111   ","   11111111111   ","  1111111111111  ","  11111EEE11111  ","   11111111111   ","   11     11     ","   1111   1111   "],
        mostro4_2: ["                 ","     4111114     ","   44111111144   ","  6 113371337 6  ","  1111111111111  "," 111111111111111 "," 111111E1E111111 ","  111111E111111  ","    11     11    ","   1111   1111   "],
        
        ufo0_1: ["           6666           ","          600006          ","      6E66666666666E6     ","  6666633666666666336666  "," 644443333444444433334446 ","  6666633666666666336666  ","   66666666466466666666   ","          468864          "],
        ufo0_2: ["           6666           ","          6BBBB6          ","      686666666666686     ","  6666633666666666336666  "," 644443333444444433334446 ","  6666633666666666336666  ","   66666666466466666666   ","         46611664         "],
        ufo1_1: ["            88            ","        2222222222        ","      22000222000222      ","22222222000222000222222222","   64447774447774447776   ","222EE2222222222222222EE222","          222222          ","      22222    22222      "],
        ufo1_2: ["            EE            ","        2222222222        ","      22000222000222      ","22222222000222000222222222","   67774447774447774446   ","22288222222222222222288222","          222222          ","      22222    22222      "],
        
        sparo: [" D ","D4D"," 4 "," 4 "," 4 "," 4 ","333","3E3"],
        msparo: ["5E5","555"," 5 "," 5 "," F "],
        
        explosion0: ["                   ","    E              ","        B          ","       4F4   E     ","       414         ","   E  413B4        "," 4  EE137EB4E E    ","  4 4E3E3DEB4E     ","  4 4BE3EDDEE 4  4 ","  E EEEEEEE14  E   ","   E4BFEEEEE4 44   ","   E44BEEEE444 E   ","   4F44EEE442   E  ","  E421EEE1E124     ","  422EB14FE122 E   "," E42EEE12444EEE    ","4 E2FF1BB11E22     ","  2E25DDDE544EE    "," 422E2  2EE4442 4  ","  2D2   2   4444   "," 244E E EE   222   "," D44    4    444   "," 2      2      2   "],
        explosion1: ["                   ","    E       4      ","         4         ","  E    4     E     ","      441E 4  6    ","4    441DB44 6     ","    EE1EEEE4E E    ","   44EDEDDEB4E 4  4"," 4 44BEEEDDEE66 E  ","    EEEDDDE14E     "," E E4BFEDEEEEE44   ","  4E4FFEDDE444     ","  44FFFDDED466 E   ","  E441EDEDE1446  4 ","  4EEEE1EFE1EE     "," E42EEE16444EEE  4 ","  EEFF1BB11E66     ","  4E25DDDE544EE    "," 422E4 44EE4442 4  ","  4D4  444  4444   "," E44E E EE   444   "," D44 E  44   444   "," 4      4      4   "],
        explosion2: ["                   ","                   ","  E        6       ","             E     ","     6F    4  6    ","       6E    6     ","    EE1E6666E E    ","   46E8ED8884E     ","   46BEE8D8EE66 8  ","    EFFD88E14E   4 ","   E4B68 88EEE44   ","  444F688DE444     ","  64666DF8DE66     ","  E44 DDEDE1E46    ","  6EFF61E8DE4E   48"," E62E6616E D6EE    ","  EEFF1B 11D86    8","  6E25DDDE5448E    "," 622E4F 44E4442    ","  4D444444446844 8 "," E66E E EE64 884   "," D44 E 6 4 6 464   "," 4  6   4 6  444   "],
        explosion3: ["                   ","                   ","                   ","                   ","     6             ","                   ","    E  D           ","   4     88        ","       E8D8EE 6 8  ","     4FD88E14    4 ","    4B68888EEE     ","    4F688DE44      ","    666  8DE66     ","   44D88E8E1E      ","   E448888DE4E     ","    E6688 DD6E     ","    448B 86D86     ","  6E65486E86488    ","   2E46464848828   ","  4D446664646888   "," E86E8886 846888   "," D4888668486888888 ","888868668868844488 "],
        explosion4: ["                   ","                   ","                   ","                   ","                   ","                   ","                   ","                   ","                   ","                   ","                   ","                4  ","                   ","      88 8 1     8 ","      8888D 4      ","     66888DD6E     ","    448 886D8688   ","  6E6868648 68888  ","  8864646 84 8688  ","  86446 668686888  "," 886E 686E8 6 6868 ","88488868 6868 8888 ","88686866886 8 66888"],
        
        pac_right1: ["         EEEE          ","      EEEEEEEEEE       ","    EEEEEEEEEEEEEE     ","   EEEEEEEEEEEEEEEE    ","   EEEEEEEEEEEEEEEE    ","  EEEEEEEEEEEEEEEEEE   ","           EEEEEEEEE   ","  EEEEEEEEEEEEEEEEEE   ","   EEEEEEEEEEEEEEEE    ","   EEEEEEEEEEEEEEEE    ","    EEEEEEEEEEEEEE     ","      EEEEEEEEEE       ","         EEEE          "],
        pac_right2: ["         EEEE          ","      EEEEEEEEEE       ","    EEEEEEEEEEEEEE     ","   EEEEEEEEEEEEEEEE    ","     EEEEEEEEEEEEEE    ","         EEEEEEEEEEE   ","           EEEEEEEEE   ","         EEEEEEEEEEE   ","     EEEEEEEEEEEEEE    ","   EEEEEEEEEEEEEEEE    ","    EEEEEEEEEEEEEE     ","      EEEEEEEEEE       ","         EEEE          "],
        pac_left1: ["          EEEE         ","       EEEEEEEEEE      ","     EEEEEEEEEEEEEE    ","    EEEEEEEEEEEEEEEE   ","    EEEEEEEEEEEEEEEE   ","   EEEEEEEEEEEEEEEEEE  ","   EEEEEEEEE           ","   EEEEEEEEEEEEEEEEEE  ","    EEEEEEEEEEEEEEEE   ","    EEEEEEEEEEEEEEEE   ","     EEEEEEEEEEEEEE    ","       EEEEEEEEEE      ","          EEEE         "],
        pac_left2: ["          EEEE         ","       EEEEEEEEEE      ","     EEEEEEEEEEEEEE    ","    EEEEEEEEEEEEEEEE   ","    EEEEEEEEEEEEEE     ","   EEEEEEEEEEE         ","   EEEEEEEEE           ","   EEEEEEEEEEE         ","    EEEEEEEEEEEEEE     ","    EEEEEEEEEEEEEEEE   ","     EEEEEEEEEEEEEE    ","       EEEEEEEEEE      ","          EEEE         "],
        ghost1: ["      77777      ","    777777777    ","  7777777777777  "," 777 7777777 777 "," 77   77777   77 "," 777 7777777 777 "," 777777777777777 "," 7777 7 7 7 7777 "," 777 7 7 7 7 777 "," 777777777777777 ","  7777 7777 7777 ","   77   77   77  "],
        ghost2: ["      77777      ","    777777777    ","  7777777777777  "," 777 7777777 777 "," 77   77777   77 "," 777 7777777 777 "," 777777777777777 "," 7777 7 7 7 7777 "," 777 7 7 7 7 777 "," 777777777777777 "," 777 7777 7777   "," 77   77   77    "],
    };

    // ============================================================================
    // AUDIO
    // ============================================================================
    
    class AudioSystem {
        constructor() { this.enabled = true; this.audioCtx = null; }
        
        init() {
            if (!this.audioCtx) this.audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
        
        play(freq, dur) {
            if (!this.enabled || !this.audioCtx) return;
            try {
                const osc = this.audioCtx.createOscillator();
                const gain = this.audioCtx.createGain();
                osc.connect(gain);
                gain.connect(this.audioCtx.destination);
                osc.frequency.value = Math.max(20, Math.min(freq, 20000));
                osc.type = 'square';
                gain.gain.setValueAtTime(0.08, this.audioCtx.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.01, this.audioCtx.currentTime + dur);
                osc.start(this.audioCtx.currentTime);
                osc.stop(this.audioCtx.currentTime + dur);
            } catch(e) {}
        }
        
        shoot() { this.play(800, 0.1); }
        explosion() { for(let i=0;i<5;i++) setTimeout(() => this.play(100+Math.random()*200, 0.15), i*50); }
        alienMove() { this.play(62, 0.05); }
        hit() { this.play(200, 0.15); }
        ufoSound(f) { this.play(f ? 1500 : 500, 0.08); }
        levelUp() { [200,300,400,500,600].forEach((f,i) => setTimeout(() => this.play(f, 0.1), i*100)); }
        toggle() { this.enabled = !this.enabled; }
    }

    // ============================================================================
    // SPRITE RENDERER
    // ============================================================================
    
    class SpriteRenderer {
        constructor() { this.cache = new Map(); }
        
        createSprite(data) {
            const key = data.join('');
            if (this.cache.has(key)) return this.cache.get(key);
            
            const h = data.length;
            const w = Math.max(...data.map(r => r.length));
            const c = document.createElement('canvas');
            c.width = w; c.height = h;
            const x = c.getContext('2d');
            
            for (let y = 0; y < h; y++) {
                const row = data[y];
                for (let i = 0; i < row.length; i++) {
                    const ch = row[i].toUpperCase();
                    if (ch !== ' ' && VGA_PALETTE[ch]) {
                        x.fillStyle = VGA_PALETTE[ch];
                        x.fillRect(i, y, 1, 1);
                    }
                }
            }
            this.cache.set(key, c);
            return c;
        }
        
        draw(ctx, data, x, y, scale = SCALE) {
            const sprite = this.createSprite(data);
            ctx.drawImage(sprite, Math.floor(x * scale), Math.floor(y * scale), sprite.width * scale, sprite.height * scale);
        }
    }

    // ============================================================================
    // GAME STATES
    // ============================================================================
    
    const GameState = { TITLE: 0, PLAYING: 1, PAUSED: 2, GAME_OVER: 3, JOKE1: 5, JOKE2: 6, JOKE3: 7, JOKE4: 8 };

    // ============================================================================
    // MAIN GAME
    // ============================================================================
    
    class AldusInvasion {
        constructor() {
            this.renderer = new SpriteRenderer();
            this.audio = new AudioSystem();
            this.state = GameState.TITLE;
            this.keys = {};
            this.reset();
            this.setupControls();
            this.timers = {};
            this.lastTime = 0;
            this.topTen = this.loadTopTen();
            this.titleFrame = 0;
            this.jokeState = null;
        }
        
        reset() {
            this.level = 1;
            this.score = 0;
            this.lives = 3;
            this.initLevel();
        }
        
        initLevel() {
            this.playerX = 150;
            this.playerAlive = true;
            this.explosionFrame = -1;
            this.explosionTimer = 0;
            this.playerBullet = null;
            
            this.aliens = [];
            this.alienDirection = 1;
            this.alienFrame = 0;
            this.alienOffsetX = 0;
            this.alienOffsetY = 0;
            this.alienDropFlag = false;
            
            this.baseAlienDelay = Math.max(400 - (this.level - 1) * 60, 100);
            this.alienBulletSpeed = 2 + Math.min(this.level - 1, 4);
            
            for (let row = 0; row < 5; row++) {
                for (let col = 0; col < 10; col++) {
                    this.aliens.push({ row, col, alive: true, type: row });
                }
            }
            
            this.alienBullets = [];
            this.ufo = null;
            this.ufoType = 0;
            this.ufoFrame = 0;
            
            this.timers = { alienMove: 0, alienShoot: 0, playerBullet: 0, alienBullet: 0, ufoMove: 0, ufoSpawn: 0, playerMove: 0 };
        }
        
        setupControls() {
            document.addEventListener('keydown', (e) => {
                this.keys[e.code] = true;
                
                if (e.code === 'Enter') {
                    this.audio.init();
                    if (this.state === GameState.TITLE || this.state === GameState.GAME_OVER) {
                        this.reset();
                        this.state = GameState.PLAYING;
                    } else if (this.state >= GameState.JOKE1) {
                        this.endJoke();
                    }
                }
                
                if (e.code === 'KeyP') {
                    if (this.state === GameState.PLAYING) this.state = GameState.PAUSED;
                    else if (this.state === GameState.PAUSED) this.state = GameState.PLAYING;
                }
                
                if (e.code === 'KeyS') this.audio.toggle();
                if (e.code === 'Space' && this.state === GameState.PLAYING) this.shoot();
                
                e.preventDefault();
            });
            
            document.addEventListener('keyup', (e) => { this.keys[e.code] = false; });
        }
        
        shoot() {
            if (!this.playerBullet && this.playerAlive) {
                this.playerBullet = { x: this.playerX + 8, y: 148 };
                this.audio.shoot();
            }
        }
        
        update(deltaTime) {
            if (this.state === GameState.TITLE) { this.titleFrame++; return; }
            if (this.state === GameState.PAUSED) return;
            if (this.state >= GameState.JOKE1) { this.updateJoke(deltaTime); return; }
            if (this.state !== GameState.PLAYING) return;
            
            for (let k in this.timers) this.timers[k] += deltaTime;
            
            // Movimento giocatore
            if (this.playerAlive && this.timers.playerMove >= TIMING.PLAYER_MOVE) {
                this.timers.playerMove = 0;
                if (this.keys['ArrowLeft'] || this.keys['KeyA']) this.playerX = Math.max(2, this.playerX - 4);
                if (this.keys['ArrowRight'] || this.keys['KeyD']) this.playerX = Math.min(300, this.playerX + 4);
            }
            
            // Sparo giocatore
            if (this.playerBullet && this.timers.playerBullet >= TIMING.PLAYER_BULLET) {
                this.timers.playerBullet = 0;
                this.playerBullet.y -= 5.5 + Math.min(this.level * 0.5, 2);
                if (this.playerBullet.y < 5) this.playerBullet = null;
                else this.checkPlayerBulletCollisions();
            }
            
            // Movimento alieni
            const aliveCount = this.aliens.filter(a => a.alive).length;
            const alienDelay = this.calculateAlienDelay(aliveCount);
            
            if (this.timers.alienMove >= alienDelay) {
                this.timers.alienMove = 0;
                this.moveAliens();
                this.audio.alienMove();
            }
            
            // Sparo alieni
            if (this.timers.alienShoot >= TIMING.ALIEN_SHOOT_CHECK) {
                this.timers.alienShoot = 0;
                this.alienShoot();
            }
            
            // Movimento spari alieni
            if (this.timers.alienBullet >= TIMING.ALIEN_BULLET) {
                this.timers.alienBullet = 0;
                this.updateAlienBullets();
            }
            
            // UFO spawn
            if (!this.ufo && this.alienOffsetY >= 15 && this.timers.ufoSpawn >= TIMING.UFO_SPAWN_CHECK) {
                this.timers.ufoSpawn = 0;
                this.trySpawnUfo();
            }
            
            // UFO movimento (più lento)
            if (this.ufo && this.timers.ufoMove >= TIMING.UFO_MOVE) {
                this.timers.ufoMove = 0;
                this.updateUfo();
            }
            
            // Vittoria
            if (aliveCount === 0) this.levelComplete();
            
            // Esplosione giocatore
            if (this.explosionFrame >= 0) {
                this.explosionTimer += deltaTime;
                if (this.explosionTimer >= 50) {
                    this.explosionTimer = 0;
                    this.explosionFrame++;
                    if (this.explosionFrame > 20) {
                        this.explosionFrame = -1;
                        if (this.lives > 0) { this.playerAlive = true; this.alienBullets = []; }
                        else this.gameOver();
                    }
                }
            }
        }
        
        calculateAlienDelay(count) {
            if (count <= 3) return 25;
            if (count <= 5) return 50;
            if (count <= 8) return 80;
            if (count <= 10) return 100;
            if (count <= 15) return 150;
            if (count <= 20) return 200;
            if (count <= 25) return 260;
            if (count <= 30) return 320;
            if (count <= 40) return 380;
            return this.baseAlienDelay;
        }
        
        moveAliens() {
            const alive = this.aliens.filter(a => a.alive);
            if (!alive.length) return;
            
            const minCol = Math.min(...alive.map(a => a.col));
            const maxCol = Math.max(...alive.map(a => a.col));
            const leftEdge = this.alienOffsetX + minCol * 25;
            const rightEdge = this.alienOffsetX + maxCol * 25 + 17;
            
            if (rightEdge >= 295 && this.alienDirection > 0) {
                this.alienDirection = -1;
                this.alienDropFlag = true;
            } else if (leftEdge <= 5 && this.alienDirection < 0) {
                this.alienDirection = 1;
                this.alienDropFlag = true;
            }
            
            if (this.alienDropFlag) {
                this.alienOffsetY += 5 + (this.level - 1) * 2;
                this.alienDropFlag = false;
            } else {
                this.alienOffsetX += this.alienDirection * 5;
            }
            
            this.alienFrame = 1 - this.alienFrame;
            
            const maxRow = Math.max(...alive.map(a => a.row));
            if (this.alienOffsetY + maxRow * 15 + 15 >= 150) {
                this.playerDeath();
                this.lives = 0;
            }
        }
        
        alienShoot() {
            if (this.alienBullets.length >= 4) return;
            
            const alive = this.aliens.filter(a => a.alive);
            if (!alive.length) return;
            
            const frontLine = {};
            for (const a of alive) {
                if (!frontLine[a.col] || a.row > frontLine[a.col].row) frontLine[a.col] = a;
            }
            
            const shooters = Object.values(frontLine);
            const chance = this.level <= 2 ? 0.25 : 0.35;
            
            if (Math.random() < chance) {
                const s = shooters[Math.floor(Math.random() * shooters.length)];
                const bx = this.alienOffsetX + s.col * 25 + 8;
                const by = this.alienOffsetY + s.row * 15 + 12;
                
                if (!this.alienBullets.some(b => Math.abs(b.x - bx) < 10)) {
                    this.alienBullets.push({ x: bx, y: by });
                }
            }
        }
        
        updateAlienBullets() {
            for (let i = this.alienBullets.length - 1; i >= 0; i--) {
                const b = this.alienBullets[i];
                b.y += this.alienBulletSpeed;
                
                if (b.y >= 195) { this.alienBullets.splice(i, 1); continue; }
                
                if (this.playerAlive && b.x >= this.playerX && b.x <= this.playerX + 17 && b.y >= 159 && b.y <= 180) {
                    this.alienBullets.splice(i, 1);
                    this.playerDeath();
                }
            }
        }
        
        trySpawnUfo() {
            const chance = this.level === 1 ? 0.06 : (this.level === 2 ? 0.04 : 0.03);
            if (Math.random() < chance) {
                const fromLeft = Math.random() < 0.5;
                this.ufo = { x: fromLeft ? -27 : 320, direction: fromLeft ? 1 : -1 };
                this.ufoType = Math.random() < 0.5 ? 0 : 1;
                this.ufoFrame = 0;
            }
        }
        
        updateUfo() {
            if (!this.ufo) return;
            this.ufo.x += this.ufo.direction * 3;
            this.ufoFrame = 1 - this.ufoFrame;
            this.audio.ufoSound(this.ufoFrame);
            if (this.ufo.x < -30 || this.ufo.x > 330) this.ufo = null;
        }
        
        checkPlayerBulletCollisions() {
            if (!this.playerBullet) return;
            
            const bx = this.playerBullet.x;
            const by = this.playerBullet.y;
            
            for (const a of this.aliens) {
                if (!a.alive) continue;
                const ax = this.alienOffsetX + a.col * 25;
                const ay = this.alienOffsetY + a.row * 15 + 15;
                
                if (bx >= ax && bx <= ax + 17 && by >= ay && by <= ay + 10) {
                    a.alive = false;
                    this.playerBullet = null;
                    this.score += 10 + a.type * 5;
                    const rem = this.aliens.filter(x => x.alive).length;
                    if (rem <= 25 - this.level * 3) this.score += 5 * this.level;
                    this.audio.hit();
                    return;
                }
            }
            
            if (this.ufo && bx >= this.ufo.x && bx <= this.ufo.x + 27 && by >= 15 && by <= 23) {
                this.score += 200 + this.ufoType * 150;
                this.audio.explosion();
                this.ufo = null;
                this.playerBullet = null;
            }
        }
        
        playerDeath() {
            if (!this.playerAlive) return;
            this.playerAlive = false;
            this.explosionFrame = 0;
            this.explosionTimer = 0;
            this.lives--;
            this.audio.explosion();
        }
        
        levelComplete() {
            this.audio.levelUp();
            this.level++;
            this.score += 100 * this.level;
            
            if (this.level === 2) this.startJoke(GameState.JOKE1);
            else if (this.level === 3) this.startJoke(GameState.JOKE2);
            else if (this.level === 4) this.startJoke(GameState.JOKE3);
            else if (this.level === 5) this.startJoke(GameState.JOKE4);
            else this.initLevel();
        }
        
        gameOver() {
            this.state = GameState.GAME_OVER;
            this.saveScore();
        }
        
        // ========================================================================
        // JOKES
        // ========================================================================
        
        startJoke(state) {
            this.state = state;
            this.jokeState = { frame: 0, timer: 0, phase: 0 };
            
            if (state === GameState.JOKE1) {
                this.jokeState.monster = { x: 10, y: 146, frame: 0 };
                this.jokeState.ufo = { x: 290, y: 10, frame: 0 };
                this.jokeState.bullets = [];
            } else if (state === GameState.JOKE2) {
                this.jokeState.ufo = { x: 5, y: 100, frame: 0 };
                this.jokeState.pac1 = { x: 5, y: 100, frame: 0 };
                this.jokeState.pac2 = { x: -35, y: 100, frame: 0 };
                this.jokeState.bullet = null;
            } else if (state === GameState.JOKE3) {
                this.jokeState.monsters = [{ x: 5, y: 70, frame: 0 }];
                this.jokeState.rocket = { x: 150, y: 139 };
                this.jokeState.ufo = null;
                this.jokeState.playerBullet = null;
            }
        }
        
        updateJoke(dt) {
            this.jokeState.timer += dt;
            if (this.jokeState.timer < TIMING.JOKE_FRAME) return;
            this.jokeState.timer = 0;
            this.jokeState.frame++;
            
            if (this.state === GameState.JOKE1) this.updateJoke1();
            else if (this.state === GameState.JOKE2) this.updateJoke2();
            else if (this.state === GameState.JOKE3) this.updateJoke3();
            else if (this.state === GameState.JOKE4) this.updateJoke4();
        }
        
        updateJoke1() {
            const j = this.jokeState;
            j.monster.x += 2;
            j.monster.frame = 1 - j.monster.frame;
            
            if (j.frame > 10 && j.ufo.x > j.monster.x + 50) {
                j.ufo.x -= 4;
                j.ufo.y += 0.3;
            }
            j.ufo.frame = 1 - j.ufo.frame;
            
            if (j.frame > 50 && j.frame % 15 === 0 && j.bullets.length < 4) {
                j.bullets.push({ x: j.ufo.x + 12, y: j.ufo.y + 8 });
            }
            
            for (let i = j.bullets.length - 1; i >= 0; i--) {
                j.bullets[i].y += 5;
                if (j.bullets[i].y > 160) j.bullets.splice(i, 1);
            }
            
            if (j.monster.x > 300) this.endJoke();
        }
        
        updateJoke2() {
            const j = this.jokeState;
            
            if (j.phase === 0) {
                j.ufo.x += 2.5;
                j.ufo.y -= 0.95;
                j.ufo.frame = 1 - j.ufo.frame;
                if (j.ufo.y < 21) j.phase = 1;
            } else if (j.phase === 1) {
                j.pac1.x += 2.5;
                j.pac1.frame = 1 - j.pac1.frame;
                j.pac2.x += 2.6;
                j.pac2.frame = 1 - j.pac2.frame;
                j.ufo.x += 0.5;
                j.ufo.y -= 0.2;
                j.ufo.frame = 1 - j.ufo.frame;
                
                if (j.ufo.x > 248 && !j.bullet) j.bullet = { x: j.ufo.x + 12, y: j.ufo.y + 58 };
                if (j.bullet) {
                    j.bullet.y += 3.8;
                    if (j.bullet.y > 106) j.phase = 2;
                }
                if (j.pac1.x > 280) j.phase = 2;
            } else if (j.phase === 2) {
                j.pac1.x -= 3.65;
                j.pac1.frame = 1 - j.pac1.frame;
                j.pac2.x -= 3.5;
                j.pac2.frame = 1 - j.pac2.frame;
                if (j.pac1.x < 5) this.endJoke();
            }
        }
        
        updateJoke3() {
            const j = this.jokeState;
            
            if (j.phase === 0) {
                j.monsters[0].x += 2.5;
                j.monsters[0].frame = 1 - j.monsters[0].frame;
                
                if (j.monsters[0].x > 18 && j.monsters.length < 2) j.monsters.push({ x: j.monsters[0].x - 18, y: 70, frame: 0 });
                if (j.monsters[0].x > 36 && j.monsters.length < 3) j.monsters.push({ x: j.monsters[0].x - 36, y: 70, frame: 0 });
                
                if (j.monsters[0].x < 200) j.rocket.x -= 1.2;
                else j.monsters[0].y += 0.6;
                
                if (j.rocket.x < 120 && !j.playerBullet) j.playerBullet = { x: j.rocket.x + 10, y: 129 };
                if (j.playerBullet) {
                    j.playerBullet.y -= 4.3;
                    if (j.playerBullet.y < 10) j.playerBullet = null;
                }
                
                if (j.monsters[0].y > 91) j.phase = 1;
            } else if (j.phase === 1) {
                if (!j.ufo) j.ufo = { x: 290, y: 30, frame: 0 };
                j.ufo.x -= 2.5;
                j.ufo.y += 0.4;
                j.ufo.frame = 1 - j.ufo.frame;
                
                for (let m of j.monsters) { m.x -= 1.1; m.frame = 1 - m.frame; }
                j.rocket.x -= 1.1;
                
                if (j.ufo.y > 90) j.phase = 2;
            } else if (j.phase === 2) {
                if (!j.ufoBullet) j.ufoBullet = { x: j.ufo.x + 12, y: j.ufo.y + 10 };
                j.ufoBullet.y += 3.8;
                
                if (j.ufoBullet.y > 136) { j.rocketExploded = true; j.explosionFrame = 0; }
                if (j.rocketExploded) {
                    j.explosionFrame++;
                    if (j.explosionFrame > 30) this.endJoke();
                }
            }
        }
        
        updateJoke4() {
            if (this.jokeState.frame > 50) this.endJoke();
        }
        
        endJoke() {
            this.jokeState = null;
            this.state = GameState.PLAYING;
            this.initLevel();
        }
        
        // ========================================================================
        // TOP TEN
        // ========================================================================
        
        loadTopTen() {
            try {
                const d = localStorage.getItem('aldusInvasionTopTen');
                return d ? JSON.parse(d) : this.defaultTopTen();
            } catch { return this.defaultTopTen(); }
        }
        
        defaultTopTen() { return Array(10).fill(null).map((_, i) => ({ name: 'Aldus Prinzi', score: 1000 - i * 100 })); }
        
        saveScore() {
            for (let i = 0; i < this.topTen.length; i++) {
                if (this.score > this.topTen[i].score) {
                    const name = prompt(`PUNTEGGIO: ${this.score}\nInserisci il tuo nome:`, 'Player');
                    if (name) {
                        this.topTen.splice(i, 0, { name: name.substring(0, 18), score: this.score });
                        this.topTen = this.topTen.slice(0, 10);
                        localStorage.setItem('aldusInvasionTopTen', JSON.stringify(this.topTen));
                    }
                    break;
                }
            }
        }
        
        // ========================================================================
        // RENDER
        // ========================================================================
        
        render() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            switch(this.state) {
                case GameState.TITLE: this.renderTitle(); break;
                case GameState.GAME_OVER: this.renderGameOver(); break;
                case GameState.JOKE1: case GameState.JOKE2: case GameState.JOKE3: case GameState.JOKE4: this.renderJoke(); break;
                default: this.renderGame(); if (this.state === GameState.PAUSED) this.renderPause();
            }
        }
        
        renderTitle() {
            ctx.fillStyle = VGA_PALETTE['E'];
            ctx.font = `${16 * SCALE}px "Press Start 2P"`;
            ctx.textAlign = 'center';
            ctx.fillText('ALDUS INVASION', WIDTH * SCALE / 2, 30 * SCALE);
            
            ctx.fillStyle = VGA_PALETTE['B'];
            ctx.font = `${8 * SCALE}px "Press Start 2P"`;
            ctx.fillText('JavaScript Edition', WIDTH * SCALE / 2, 45 * SCALE);
            
            const types = ['mostro0', 'mostro1', 'mostro2', 'mostro3', 'mostro4'];
            const names = ['Giacomo', 'Giovanni', 'Vincenzo', 'Aldo', 'Vicky'];
            const pts = [10, 15, 20, 25, 30];
            
            for (let i = 0; i < 5; i++) {
                const f = Math.floor(this.titleFrame / 30) % 2 + 1;
                const k = types[i] + '_' + f;
                if (SPRITE_DATA[k]) this.renderer.draw(ctx, SPRITE_DATA[k], 90, 60 + i * 25);
                
                ctx.fillStyle = VGA_PALETTE['7'];
                ctx.font = `${8 * SCALE}px "Press Start 2P"`;
                ctx.textAlign = 'left';
                ctx.fillText(`${names[i]} = ${pts[i]} pts`, 120 * SCALE, (70 + i * 25) * SCALE);
            }
            
            ctx.fillStyle = (Math.floor(this.titleFrame / 20) % 2) ? VGA_PALETTE['E'] : VGA_PALETTE['F'];
            ctx.textAlign = 'center';
            ctx.fillText('PREMI ENTER PER INIZIARE', WIDTH * SCALE / 2, 180 * SCALE);
            
            ctx.fillStyle = VGA_PALETTE['3'];
            ctx.font = `${6 * SCALE}px "Press Start 2P"`;
            ctx.fillText('FREEWARE by ALDO PRINZI 1994', WIDTH * SCALE / 2, 195 * SCALE);
        }
        
        renderGame() {
            ctx.fillStyle = VGA_PALETTE['8'];
            ctx.fillRect(0, 183 * SCALE, WIDTH * SCALE, 3 * SCALE);
            
            ctx.fillStyle = VGA_PALETTE['F'];
            ctx.font = `${8 * SCALE}px "Press Start 2P"`;
            ctx.textAlign = 'left';
            ctx.fillText(`${this.score.toString().padStart(6, ' ')} Pts`, 5 * SCALE, 10 * SCALE);
            
            ctx.fillStyle = VGA_PALETTE['E'];
            ctx.textAlign = 'center';
            ctx.fillText(`LEVEL ${this.level}`, WIDTH * SCALE / 2, 10 * SCALE);
            
            ctx.fillStyle = VGA_PALETTE['3'];
            ctx.textAlign = 'right';
            ctx.fillText(`Lives: ${this.lives}`, (WIDTH - 5) * SCALE, 10 * SCALE);
            
            if (this.playerAlive) {
                this.renderer.draw(ctx, SPRITE_DATA.razzo, this.playerX, 159);
            } else if (this.explosionFrame >= 0) {
                const k = 'explosion' + Math.min(Math.floor(this.explosionFrame / 5), 4);
                if (SPRITE_DATA[k]) this.renderer.draw(ctx, SPRITE_DATA[k], this.playerX, 159);
            }
            
            for (const a of this.aliens) {
                if (!a.alive) continue;
                const x = this.alienOffsetX + a.col * 25;
                const y = this.alienOffsetY + a.row * 15 + 15;
                const k = `mostro${a.type}_${this.alienFrame + 1}`;
                if (SPRITE_DATA[k]) this.renderer.draw(ctx, SPRITE_DATA[k], x, y);
            }
            
            if (this.playerBullet) this.renderer.draw(ctx, SPRITE_DATA.sparo, this.playerBullet.x - 1, this.playerBullet.y);
            for (const b of this.alienBullets) this.renderer.draw(ctx, SPRITE_DATA.msparo, b.x - 1, b.y);
            
            if (this.ufo) {
                const k = `ufo${this.ufoType}_${this.ufoFrame + 1}`;
                if (SPRITE_DATA[k]) this.renderer.draw(ctx, SPRITE_DATA[k], this.ufo.x, 15);
            }
        }
        
        renderJoke() {
            ctx.fillStyle = VGA_PALETTE['1'];
            ctx.fillRect(0, 145 * SCALE, WIDTH * SCALE, 15 * SCALE);
            
            ctx.strokeStyle = VGA_PALETTE['0'];
            ctx.setLineDash([4 * SCALE, 4 * SCALE]);
            ctx.beginPath();
            ctx.moveTo(0, 154 * SCALE);
            ctx.lineTo(WIDTH * SCALE, 154 * SCALE);
            ctx.stroke();
            ctx.setLineDash([]);
            
            ctx.fillStyle = VGA_PALETTE['2'];
            ctx.font = `${8 * SCALE}px "Press Start 2P"`;
            ctx.textAlign = 'center';
            ctx.fillText('Intermezzo', WIDTH * SCALE / 2, 190 * SCALE);
            
            const j = this.jokeState;
            if (!j) return;
            
            if (this.state === GameState.JOKE1) {
                const ms = j.monster.frame ? SPRITE_DATA.mostro3_1 : SPRITE_DATA.mostro3_2;
                this.renderer.draw(ctx, ms, j.monster.x, j.monster.y);
                const us = j.ufo.frame ? SPRITE_DATA.ufo0_1 : SPRITE_DATA.ufo0_2;
                this.renderer.draw(ctx, us, j.ufo.x, j.ufo.y);
                for (const b of j.bullets) this.renderer.draw(ctx, SPRITE_DATA.msparo, b.x, b.y);
            } else if (this.state === GameState.JOKE2) {
                const us = j.ufo.frame ? SPRITE_DATA.ufo1_1 : SPRITE_DATA.ufo1_2;
                this.renderer.draw(ctx, us, j.ufo.x, 50 + j.ufo.y);
                
                if (j.phase < 2) {
                    const ps = j.pac1.frame ? SPRITE_DATA.pac_right1 : SPRITE_DATA.pac_right2;
                    this.renderer.draw(ctx, ps, j.pac1.x, 100);
                    if (j.pac2.x > 0) this.renderer.draw(ctx, j.pac2.frame ? SPRITE_DATA.ghost1 : SPRITE_DATA.ghost2, j.pac2.x, 100);
                } else {
                    const ps = j.pac1.frame ? SPRITE_DATA.pac_left1 : SPRITE_DATA.pac_left2;
                    this.renderer.draw(ctx, ps, j.pac1.x, 100);
                    if (j.pac2.x > 0) this.renderer.draw(ctx, j.pac2.frame ? SPRITE_DATA.ghost1 : SPRITE_DATA.ghost2, j.pac2.x, 100);
                }
                if (j.bullet) this.renderer.draw(ctx, SPRITE_DATA.msparo, j.bullet.x, j.bullet.y);
            } else if (this.state === GameState.JOKE3) {
                ctx.fillStyle = VGA_PALETTE['8'];
                ctx.fillRect(0, 163 * SCALE, WIDTH * SCALE, 3 * SCALE);
                
                for (const m of j.monsters) {
                    const ms = m.frame ? SPRITE_DATA.mostro3_1 : SPRITE_DATA.mostro3_2;
                    this.renderer.draw(ctx, ms, m.x, m.y);
                }
                
                if (!j.rocketExploded) {
                    this.renderer.draw(ctx, SPRITE_DATA.razzo, j.rocket.x, j.rocket.y);
                } else {
                    const k = 'explosion' + Math.min(Math.floor(j.explosionFrame / 5), 4);
                    if (SPRITE_DATA[k]) this.renderer.draw(ctx, SPRITE_DATA[k], j.rocket.x, j.rocket.y);
                }
                
                if (j.playerBullet) this.renderer.draw(ctx, SPRITE_DATA.sparo, j.playerBullet.x, j.playerBullet.y);
                if (j.ufo) {
                    const us = j.ufo.frame ? SPRITE_DATA.ufo1_1 : SPRITE_DATA.ufo1_2;
                    this.renderer.draw(ctx, us, j.ufo.x, j.ufo.y);
                }
                if (j.ufoBullet && !j.rocketExploded) this.renderer.draw(ctx, SPRITE_DATA.msparo, j.ufoBullet.x, j.ufoBullet.y);
            } else if (this.state === GameState.JOKE4) {
                ctx.fillStyle = VGA_PALETTE['E'];
                ctx.font = `${10 * SCALE}px "Press Start 2P"`;
                ctx.textAlign = 'center';
                ctx.fillText('You have reached', WIDTH * SCALE / 2, 60 * SCALE);
                ctx.fillText('LEVEL 5!', WIDTH * SCALE / 2, 80 * SCALE);
                
                ctx.fillStyle = VGA_PALETTE['7'];
                ctx.font = `${6 * SCALE}px "Press Start 2P"`;
                ctx.fillText('(Joke4 was left empty by the author)', WIDTH * SCALE / 2, 110 * SCALE);
                ctx.fillText('"QUESTO METTETECELO VOI!"', WIDTH * SCALE / 2, 125 * SCALE);
            }
            
            ctx.fillStyle = VGA_PALETTE['7'];
            ctx.font = `${6 * SCALE}px "Press Start 2P"`;
            ctx.textAlign = 'center';
            ctx.fillText('ENTER per saltare', WIDTH * SCALE / 2, 198 * SCALE);
        }
        
        renderPause() {
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = VGA_PALETTE['E'];
            ctx.font = `${16 * SCALE}px "Press Start 2P"`;
            ctx.textAlign = 'center';
            ctx.fillText('PAUSA', WIDTH * SCALE / 2, HEIGHT * SCALE / 2);
            
            ctx.fillStyle = VGA_PALETTE['7'];
            ctx.font = `${8 * SCALE}px "Press Start 2P"`;
            ctx.fillText('Premi P per continuare', WIDTH * SCALE / 2, (HEIGHT / 2 + 20) * SCALE);
        }
        
        renderGameOver() {
            ctx.fillStyle = VGA_PALETTE['4'];
            ctx.font = `${16 * SCALE}px "Press Start 2P"`;
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', WIDTH * SCALE / 2, 50 * SCALE);
            
            ctx.fillStyle = VGA_PALETTE['F'];
            ctx.font = `${10 * SCALE}px "Press Start 2P"`;
            ctx.fillText(`Punteggio: ${this.score}`, WIDTH * SCALE / 2, 75 * SCALE);
            
            ctx.fillStyle = VGA_PALETTE['E'];
            ctx.font = `${8 * SCALE}px "Press Start 2P"`;
            ctx.fillText('TOP TEN', WIDTH * SCALE / 2, 95 * SCALE);
            
            ctx.font = `${6 * SCALE}px "Press Start 2P"`;
            for (let i = 0; i < this.topTen.length; i++) {
                const e = this.topTen[i];
                ctx.fillStyle = VGA_PALETTE['7'];
                ctx.textAlign = 'right';
                ctx.fillText(`${i + 1}.`, 80 * SCALE, (110 + i * 8) * SCALE);
                ctx.textAlign = 'left';
                ctx.fillText(e.name, 85 * SCALE, (110 + i * 8) * SCALE);
                ctx.textAlign = 'right';
                ctx.fillText(e.score.toString(), 250 * SCALE, (110 + i * 8) * SCALE);
            }
            
            ctx.fillStyle = (Date.now() % 1000 < 500) ? VGA_PALETTE['E'] : VGA_PALETTE['F'];
            ctx.textAlign = 'center';
            ctx.font = `${8 * SCALE}px "Press Start 2P"`;
            ctx.fillText('PREMI ENTER', WIDTH * SCALE / 2, 195 * SCALE);
        }
        
        // ========================================================================
        // GAME LOOP
        // ========================================================================
        
        gameLoop(ts) {
            const dt = Math.min(ts - this.lastTime, 50);
            this.lastTime = ts;
            this.update(dt);
            this.render();
            requestAnimationFrame((t) => this.gameLoop(t));
        }
        
        start() { this.gameLoop(0); }
    }

    // ============================================================================
    // START
    // ============================================================================
    
    const game = new AldusInvasion();
    game.start();
    
    </script>
</body>
</html>
